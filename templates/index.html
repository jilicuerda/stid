<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>VolleyStats Pro - Master</title>
    <style>
        /* CSS BASIQUE MAIS FONCTIONNEL */
        :root { --primary: #2c3e50; --accent: #e74c3c; --success: #27ae60; --light: #ecf0f1; }
        body { font-family: sans-serif; margin: 0; padding: 10px; background: #f4f4f4; user-select: none; }
        .hidden { display: none !important; }
        
        /* Conteneur Principal */
        .container { max-width: 1000px; margin: 0 auto; background: white; padding: 15px; border-radius: 8px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
        
        /* Boutons */
        .btn { padding: 12px; border: none; border-radius: 6px; cursor: pointer; font-weight: bold; width: 100%; color: white; margin-bottom: 5px; font-size: 1rem; }
        .btn:hover { opacity: 0.9; }
        .btn-green { background: var(--success); }
        .btn-blue { background: var(--primary); }
        .btn-red { background: var(--accent); }
        .btn-gray { background: #95a5a6; }
        .btn-outline { background: transparent; border: 2px solid var(--primary); color: var(--primary); }

        /* Header & Score */
        .top-bar { display: flex; justify-content: space-between; align-items: center; border-bottom: 2px solid #eee; padding-bottom: 10px; }
        .scoreboard { display: flex; justify-content: center; align-items: center; gap: 30px; margin: 15px 0; font-size: 3rem; font-weight: 800; color: #333; }
        .sets-display { font-size: 1.2rem; background: #eee; padding: 5px 15px; border-radius: 20px; color: #555; }

        /* Terrain de Volley */
        .court-container { display: flex; justify-content: space-between; gap: 10px; margin-bottom: 15px; }
        .court-side { border: 3px solid #333; width: 49%; height: 300px; position: relative; background: #fff; }
        .net { position: absolute; top: 0; bottom: 0; width: 4px; background: black; z-index: 10; }
        .left-net { left: 100%; } .right-net { left: 0; }
        
        /* Joueurs (Ronds) */
        .player-pos { 
            width: 40px; height: 40px; background: white; border: 2px solid #ccc; border-radius: 50%;
            position: absolute; display: flex; flex-direction: column; align-items: center; justify-content: center; 
            font-size: 0.8em; font-weight: bold; cursor: pointer; z-index: 5;
            box-shadow: 2px 2px 5px rgba(0,0,0,0.2);
        }
        .player-pos.server { border-color: var(--accent); border-width: 3px; background: #fff5e6; }
        
        /* Positions (Z1-Z6) */
        .p4 { top: 20%; left: 20%; } .p3 { top: 20%; left: 50%; } .p2 { top: 20%; left: 80%; }
        .p5 { top: 70%; left: 20%; } .p6 { top: 70%; left: 50%; } .p1 { top: 70%; left: 80%; }
        /* Miroir pour l'adversaire */
        .right-side .p2 { left: 20%; } .right-side .p3 { left: 50%; } .right-side .p4 { left: 80%; }
        .right-side .p1 { left: 20%; } .right-side .p6 { left: 50%; } .right-side .p5 { left: 80%; }

        /* Modales */
        .modal-overlay { position: fixed; top:0; left:0; width:100%; height:100%; background: rgba(0,0,0,0.8); z-index:100; display: flex; align-items: center; justify-content: center; }
        .modal-box { background: white; width: 95%; max-width: 600px; padding: 20px; border-radius: 10px; max-height: 90vh; overflow-y: auto; }
        
        /* Grilles de s√©lection */
        .grid-players { display: grid; grid-template-columns: repeat(6, 1fr); gap: 5px; margin: 10px 0; }
        .sel-btn { padding: 10px; border: 1px solid #ddd; text-align: center; cursor: pointer; border-radius: 4px; }
        .sel-btn.selected { background: var(--primary); color: white; }
        
        .grid-actions { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-top: 10px; }
        .act-btn { padding: 15px; border: 1px solid #ddd; cursor: pointer; border-radius: 4px; text-align: center; font-weight: bold; }
        .act-good { border-left: 5px solid var(--success); }
        .act-bad { border-left: 5px solid var(--accent); }
    </style>
</head>
<body>

<div id="setupModal" class="modal-overlay">
    <div class="modal-box">
        <div id="stepLoad">
            <h2>VolleyStats Pro</h2>
            <button class="btn btn-green" onclick="showStep('step1')">‚≠ê Nouveau Match</button>
            <div style="margin-top:20px; border: 2px dashed #ccc; padding: 20px; text-align: center; cursor: pointer;" onclick="document.getElementById('fileInput').click()">
                üìÇ Charger une Sauvegarde JSON
                <input type="file" id="fileInput" accept=".json" style="display: none;" onchange="loadGameFromFile(this)">
            </div>
        </div>

        <div id="step1" class="hidden">
            <h3>Configuration Match</h3>
            <label>Nous (Domicile)</label><input type="text" id="homeName" value="Mon Club" style="width:100%; padding:8px; margin-bottom:10px;">
            <label>Eux (Ext√©rieur)</label><input type="text" id="awayName" value="Adversaire" style="width:100%; padding:8px; margin-bottom:10px;">
            <label>Premier Service</label>
            <select id="firstServer" style="width:100%; padding:8px; margin-bottom:20px;">
                <option value="home">Nous</option>
                <option value="away">Eux</option>
            </select>
            <div style="display:flex; gap:10px;">
                <button class="btn btn-gray" onclick="showStep('stepLoad')">Retour</button>
                <button class="btn btn-green" onclick="initRostersUI(); showStep('step2')">Suivant</button>
            </div>
        </div>

        <div id="step2" class="hidden">
            <h3>Effectifs</h3>
            <div style="display:flex; gap:10px; margin-bottom:20px;">
                <div style="flex:1">
                    <h4>Nous</h4>
                    <div id="homeRosterList"></div>
                    <button class="btn btn-gray" onclick="addPlayerRow('home')">+ Joueur</button>
                </div>
                <div style="flex:1; border-left:1px solid #ccc; padding-left:10px;">
                    <h4>Eux (N¬∞ seulement)</h4>
                    <div id="awayRosterList"></div>
                    <button class="btn btn-gray" onclick="addPlayerRow('away')">+ Joueur</button>
                </div>
            </div>
            <div style="display:flex; gap:10px;">
                <button class="btn btn-gray" onclick="showStep('step1')">Retour</button>
                <button class="btn btn-green" onclick="startGame()">Lancer le Match üèê</button>
            </div>
        </div>
    </div>
</div>

<div id="scoreModal" class="modal-overlay hidden">
    <div class="modal-box">
        <h3 id="scoreTitle" style="text-align:center;">Point...</h3>
        
        <div id="secWinner">
            <h4 style="color:var(--success); margin:5px 0;">1. Point Gagnant (Notre Action)</h4>
            <div id="gridWinners" class="grid-players"></div>
            <div id="actionsWinner" class="grid-actions hidden">
                <div class="act-btn act-good" onclick="finalizeScore('Attaque')">Attaque</div>
                <div class="act-btn act-good" onclick="finalizeScore('Block')">Block</div>
                <div class="act-btn act-good" onclick="finalizeScore('Ace')">Ace</div>
                <div class="act-btn act-good" onclick="finalizeScore('Feinte')">Feinte</div>
            </div>
        </div>

        <hr style="margin:15px 0;">

        <div id="secLoser">
            <h4 style="color:var(--accent); margin:5px 0;">2. Faute Adverse (Leur Erreur)</h4>
            <div id="gridLosers" class="grid-players"></div>
            <div id="actionsLoser" class="grid-actions hidden">
                <div class="act-btn act-bad" onclick="finalizeScore('Attaque Out')">Attaque Out</div>
                <div class="act-btn act-bad" onclick="finalizeScore('Faute Filet')">Filet</div>
                <div class="act-btn act-bad" onclick="finalizeScore('Faute Service')">Service Rat√©</div>
                <div class="act-btn act-bad" onclick="finalizeScore('Faute Main')">Faute Main</div>
            </div>
        </div>

        <button class="btn btn-gray" onclick="closeModal('scoreModal')" style="margin-top:15px;">Annuler</button>
    </div>
</div>

<div id="subModal" class="modal-overlay hidden">
    <div class="modal-box">
        <h3>Changement</h3>
        <p>Sortie : <strong id="subOutName">...</strong></p>
        <select id="subInSelect" style="width:100%; padding:10px; margin-bottom:15px;"></select>
        <button class="btn btn-green" onclick="confirmSub()">Confirmer</button>
        <button class="btn btn-gray" onclick="closeModal('subModal')">Annuler</button>
    </div>
</div>

<div class="container" id="gameUI" style="display:none;">
    
    <div class="top-bar">
        <div>
            <strong>Set <span id="setNum">1</span></strong>
            <div id="matchVersus" style="font-size:0.8em; color:#666;"></div>
        </div>
        <div class="sets-display">Sets : <span id="gSetHome">0</span> - <span id="gSetAway">0</span></div>
        <div style="display:flex; gap:5px;">
            <button class="btn btn-gray" style="width:auto; font-size:0.8rem;" onclick="downloadBackup()">üíæ Backup</button>
            <button class="btn btn-blue" style="width:auto; font-size:0.8rem;" onclick="sendToDB()">‚òÅÔ∏è Envoyer</button>
        </div>
    </div>

    <div class="scoreboard">
        <div style="text-align:center;">
            <span style="font-size:1rem; display:block; color:#666;" id="lblHome">Nous</span>
            <span id="scoreHome">0</span>
        </div>
        <div>-</div>
        <div style="text-align:center;">
            <span style="font-size:1rem; display:block; color:#666;" id="lblAway">Eux</span>
            <span id="scoreAway">0</span>
        </div>
    </div>

    <div class="court-container">
        <div class="court-side" id="cHome">
            <div class="net left-net"></div>
            <div class="player-pos p4" id="h_p4" onclick="openSub('home', 3)"></div>
            <div class="player-pos p3" id="h_p3" onclick="openSub('home', 2)"></div>
            <div class="player-pos p2" id="h_p2" onclick="openSub('home', 1)"></div>
            <div class="player-pos p5" id="h_p5" onclick="openSub('home', 4)"></div>
            <div class="player-pos p6" id="h_p6" onclick="openSub('home', 5)"></div>
            <div class="player-pos p1" id="h_p1" onclick="openSub('home', 0)"></div>
        </div>
        <div class="court-side right-side" id="cAway">
            <div class="net right-net"></div>
            <div class="player-pos p4" id="a_p4" onclick="openSub('away', 3)"></div>
            <div class="player-pos p3" id="a_p3" onclick="openSub('away', 2)"></div>
            <div class="player-pos p2" id="a_p2" onclick="openSub('away', 1)"></div>
            <div class="player-pos p5" id="a_p1" onclick="openSub('away', 4)"></div>
            <div class="player-pos p6" id="a_p6" onclick="openSub('away', 5)"></div>
            <div class="player-pos p1" id="a_p5" onclick="openSub('away', 0)"></div>
        </div>
    </div>

    <div style="display:grid; grid-template-columns: 1fr 1fr; gap:20px;">
        <button class="btn btn-blue" onclick="openScoreModal('home')">+ POINT NOUS</button>
        <button class="btn btn-blue" onclick="openScoreModal('away')">+ POINT EUX</button>
    </div>

    <hr style="margin:20px 0;">

    <div style="display:flex; gap:10px;">
        <button class="btn btn-red" onclick="endSet()">üèÅ FIN DU SET (Auto-Save)</button>
        <button class="btn btn-outline" onclick="resetMatch()">‚ö†Ô∏è RESET MATCH</button>
    </div>
</div>

<script>
    // --- ETAT DU JEU (MODEL) ---
    let state = {
        home: { name: "", score: 0, sets: 0, players: [], onCourt: [] },
        away: { name: "", score: 0, sets: 0, players: [], onCourt: [] },
        server: null, // 'home' ou 'away'
        set: 1,
        history: [],
        tempPoint: {}
    };

    // --- NAVIGATION & SETUP ---
    function showStep(id) {
        ['stepLoad', 'step1', 'step2'].forEach(s => document.getElementById(s).classList.add('hidden'));
        document.getElementById(id).classList.remove('hidden');
    }

    function initRostersUI() {
        if(document.getElementById('homeRosterList').innerHTML === "") for(let i=0; i<8; i++) addPlayerRow('home', i);
        if(document.getElementById('awayRosterList').innerHTML === "") for(let i=0; i<8; i++) addPlayerRow('away', i);
    }

    function addPlayerRow(team, idx) {
        const container = document.getElementById(team + 'RosterList');
        const count = container.children.length;
        const div = document.createElement('div');
        div.style.marginBottom = "5px";
        const lbl = count < 6 ? `<b>Z${count+1}</b>` : `<span style="color:#999">R</span>`;
        
        let html = `${lbl} <input type="number" id="${team}_num_${count}" placeholder="#" style="width:50px; padding:5px;">`;
        if(team === 'home') {
            html += ` <input type="text" id="${team}_name_${count}" placeholder="Nom" style="width:80px; padding:5px;">
                      <select id="${team}_role_${count}" style="padding:5px;">
                        <option value="?">?</option><option value="P">P</option><option value="R4">R4</option><option value="C">C</option><option value="Pt">Pt</option><option value="L">L</option>
                      </select>`;
        }
        div.innerHTML = html;
        container.appendChild(div);
    }

    // --- DEMARRAGE ---
    function startGame() {
        // 1. Noms
        state.home.name = document.getElementById('homeName').value;
        state.away.name = document.getElementById('awayName').value;
        state.server = document.getElementById('firstServer').value;

        // 2. Parser Effectifs
        const parse = (team) => {
            const list = document.getElementById(team+'RosterList').children;
            let roster = [], starters = [];
            for(let i=0; i<list.length; i++) {
                let num = document.getElementById(`${team}_num_${i}`).value;
                let name = document.getElementById(`${team}_name_${i}`) ? document.getElementById(`${team}_name_${i}`).value : 'Adv#'+num;
                let role = document.getElementById(`${team}_role_${i}`) ? document.getElementById(`${team}_role_${i}`).value : '?';
                
                if(num) {
                    let p = { num, name: name || 'J'+num, role, id: i };
                    roster.push(p);
                    if(i < 6) starters.push(p);
                }
            }
            while(starters.length < 6) starters.push({num:'?', name:'?', role:'?'});
            return { all: roster, court: starters };
        };

        const h = parse('home'); state.home.players = h.all; state.home.onCourt = h.court;
        const a = parse('away'); state.away.players = a.all; state.away.onCourt = a.court;

        // 3. Afficher Interface
        updateUI();
        document.getElementById('setupModal').classList.add('hidden');
        document.getElementById('gameUI').style.display = 'block';
    }

    // --- MOTEUR DE JEU (ROTATIONS & POINTS) ---
    function openScoreModal(winner) {
        state.tempPoint = { winner, actorTeam: null, actorNum: null };
        const loser = winner === 'home' ? 'away' : 'home';
        
        document.getElementById('scoreTitle').innerText = `Point pour ${state[winner].name}`;
        document.getElementById('actionsWinner').classList.add('hidden');
        document.getElementById('actionsLoser').classList.add('hidden');
        
        // Remplir les grilles
        fillGrid('gridWinners', winner, true);
        fillGrid('gridLosers', loser, false);
        
        document.getElementById('scoreModal').classList.remove('hidden');
    }

    function fillGrid(elemId, team, isPositive) {
        const div = document.getElementById(elemId); div.innerHTML = '';
        state[team].onCourt.forEach(p => {
            let btn = document.createElement('div');
            btn.className = 'sel-btn';
            btn.innerText = p.num;
            btn.onclick = () => {
                document.querySelectorAll('.sel-btn').forEach(b => b.classList.remove('selected'));
                btn.classList.add('selected');
                state.tempPoint.actorTeam = team; state.tempPoint.actorNum = p.num;
                document.getElementById(isPositive ? 'actionsWinner' : 'actionsLoser').classList.remove('hidden');
                document.getElementById(isPositive ? 'actionsLoser' : 'actionsWinner').classList.add('hidden');
            };
            div.appendChild(btn);
        });
    }

    function finalizeScore(action) {
        const { winner, actorTeam, actorNum } = state.tempPoint;
        
        // Sauvegarder contexte avant modif
        const servT = state.server;
        const servNum = state[servT].onCourt[0].num;
        const rotH = state.home.onCourt.map(p=>p.num).join('-');
        const rotA = state.away.onCourt.map(p=>p.num).join('-');

        // Score +1
        state[winner].score++;

        // Historique
        state.history.push({
            set: state.set,
            score_dom: state.home.score, score_ext: state.away.score,
            winner_team: state[winner].name,
            point_type: (actorTeam === winner) ? 'Gagnant' : 'Faute',
            action: action,
            actor_num: actorNum, actor_team: state[actorTeam].name,
            server_team: state[servT].name, server_num: servNum,
            rot_home: rotH, rot_away: rotA
        });

        // Rotation (Sideout)
        if(state.server !== winner) {
            let mover = state[winner].onCourt.shift();
            state[winner].onCourt.push(mover);
            state.server = winner;
        }

        closeModal('scoreModal');
        updateUI();
    }

    // --- CHANGEMENTS & FIN DE SET ---
    function openSub(team, idx) {
        state.subTarget = { team, idx };
        const sel = document.getElementById('subInSelect'); sel.innerHTML = '';
        const currentIds = state[team].onCourt.map(p => p.num);
        
        state[team].players.forEach(p => {
            if(!currentIds.includes(p.num)) {
                let opt = document.createElement('option');
                opt.value = p.num; opt.innerText = `#${p.num} ${p.name}`;
                sel.appendChild(opt);
            }
        });
        document.getElementById('subOutName').innerText = state[team].onCourt[idx].name;
        document.getElementById('subModal').classList.remove('hidden');
    }

    function confirmSub() {
        const { team, idx } = state.subTarget;
        const val = document.getElementById('subInSelect').value;
        state[team].onCourt[idx] = state[team].players.find(p => p.num == val);
        closeModal('subModal');
        updateUI();
    }

    function endSet() {
        if(!confirm("Fin du set ? Une sauvegarde sera t√©l√©charg√©e.")) return;
        
        // Qui a gagn√© le set ?
        if(state.home.score > state.away.score) state.home.sets++; else state.away.sets++;
        
        downloadBackup(); // Auto-save JSON
        
        // Reset Set
        state.set++;
        state.home.score = 0; state.away.score = 0;
        updateUI();
    }

    // --- SAUVEGARDE & RESTAURATION (JSON) ---
    function downloadBackup() {
        const data = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(state));
        const a = document.createElement('a');
        a.href = data; a.download = `BACKUP_Set${state.set}_${Date.now()}.json`;
        document.body.appendChild(a); a.click(); a.remove();
    }

    function loadGameFromFile(input) {
        const file = input.files[0];
        if(!file) return;
        const reader = new FileReader();
        reader.onload = (e) => {
            try {
                state = JSON.parse(e.target.result);
                updateUI();
                document.getElementById('setupModal').classList.add('hidden');
                document.getElementById('gameUI').style.display = 'block';
                alert("Sauvegarde charg√©e avec succ√®s !");
            } catch(err) { alert("Erreur fichier JSON."); }
        };
        reader.readAsText(file);
    }

    async function sendToDB() {
        if(!confirm("Envoyer vers la base de donn√©es (Cloud) ?")) return;
        const payload = {
            homeName: state.home.name, awayName: state.away.name,
            setsHome: state.home.sets, setsAway: state.away.sets,
            winner: state.home.sets > state.away.sets ? state.home.name : "En cours",
            history: state.history
        };
        try {
            const res = await fetch('/api/save_match', {
                method: 'POST', 
                headers: {'Content-Type': 'application/json'}, 
                body: JSON.stringify(payload)
            });
            const json = await res.json();
            alert(json.message);
        } catch(e) { alert("Erreur connexion Cloud : " + e); }
    }

    // --- RENDU UI ---
    function updateUI() {
        document.getElementById('lblHome').innerText = state.home.name;
        document.getElementById('lblAway').innerText = state.away.name;
        document.getElementById('scoreHome').innerText = state.home.score;
        document.getElementById('scoreAway').innerText = state.away.score;
        document.getElementById('gSetHome').innerText = state.home.sets;
        document.getElementById('gSetAway').innerText = state.away.sets;
        document.getElementById('setNum').innerText = state.set;
        document.getElementById('matchVersus').innerText = `${state.home.name} vs ${state.away.name}`;

        const draw = (team, prefix) => {
            state[team].onCourt.forEach((p, i) => {
                const el = document.getElementById(`${prefix}${i+1}`);
                el.innerHTML = `<span>${p.num}</span>`;
                if(state.server === team && i === 0) el.classList.add('server');
                else el.classList.remove('server');
            });
        };
        draw('home', 'h_p'); draw('away', 'a_p');
    }

    function closeModal(id) { document.getElementById(id).classList.add('hidden'); }
    function resetMatch() { if(confirm("Tout effacer ?")) location.reload(); }

</script>
</body>
</html>
