<!DOCTYPE html>
<html class="light" lang="en">
<head>
    <meta charset="utf-8"/>
    <meta content="width=device-width, initial-scale=1.0" name="viewport"/>
    <title>VolleyLive Pro - Match Console</title>
    
    <script src="https://cdn.tailwindcss.com?plugins=forms,container-queries"></script>
    
    <script src="https://cdn.sheetjs.com/xlsx-latest/package/dist/xlsx.full.min.js"></script>

    <link href="https://fonts.googleapis.com/css2?family=Lexend:wght@300;400;500;600;700&display=swap" rel="stylesheet"/>
    <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:wght,FILL@100..700,0..1&display=swap" rel="stylesheet"/>
    
    <script>
        tailwind.config = {
            darkMode: "class",
            theme: {
                extend: {
                    colors: { "primary": "#135bec", "bg-light": "#f6f6f8", "bg-dark": "#101622" },
                    fontFamily: { "display": ["Lexend", "sans-serif"] },
                },
            },
        }
    </script>
    <style>
        .court-wood {
            background-color: #e5c08a;
            background-image: linear-gradient(rgba(255, 255, 255, 0.1) 1px, transparent 1px), linear-gradient(90deg, rgba(255, 255, 255, 0.1) 1px, transparent 1px);
            background-size: 20px 20px;
        }
        .net-pattern { background-image: radial-gradient(circle, #333 1px, transparent 1px); background-size: 4px 4px; }
        .material-symbols-outlined { font-variation-settings: 'FILL' 0, 'wght' 400, 'GRAD' 0, 'opsz' 24; }
        .hidden { display: none !important; }
        
        /* Styles des joueurs */
        .player-circle {
            width: 3rem; height: 3rem;
            border-radius: 9999px;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            font-weight: bold; border-width: 4px; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
            cursor: pointer; transition: transform 0.1s;
        }
        .player-circle:active { transform: scale(0.95); }
        .server-indicator { border-color: #ef4444 !important; box-shadow: 0 0 0 4px rgba(239, 68, 68, 0.3); }
    </style>
</head>
<body class="bg-bg-light dark:bg-bg-dark font-display text-[#111318] dark:text-white min-h-screen flex flex-col">

    <script>
        class VolleyMatch {
            constructor() { this.resetState(); }
            resetState() {
                this.state = {
                    home: { name: "Home", score: 0, sets: 0, players: [], onCourt: [] },
                    away: { name: "Away", score: 0, sets: 0, players: [], onCourt: [] },
                    server: null, set: 1, history: [],
                    tempPoint: { winner: null, actorTeam: null, actorNum: null },
                    subTarget: { team: null, idx: null }
                };
            }
            initializeMatch(hName, aName, serv, hRoster, hCourt, aRoster, aCourt) {
                this.state.home.name = hName; this.state.home.players = hRoster; this.state.home.onCourt = hCourt;
                this.state.away.name = aName; this.state.away.players = aRoster; this.state.away.onCourt = aCourt;
                this.state.server = serv; this.state.set = 1; this.state.history = [];
            }
            scorePoint(winner, details) {
                const sTeam = this.state.server;
                const sNum = this.state[sTeam].onCourt[0].num;
                this.state[winner].score++;
                this.state.history.push({
                    set: this.state.set, score_dom: this.state.home.score, score_ext: this.state.away.score,
                    winner_team: this.state[winner].name, action: details.action, actor_num: details.actorNum,
                    server_team: this.state[sTeam].name, server_num: sNum,
                    rot_home: this.state.home.onCourt.map(p=>p.num).join('-'),
                    rot_away: this.state.away.onCourt.map(p=>p.num).join('-')
                });
                if(this.state.server !== winner) { this.rotate(winner); this.state.server = winner; }
            }
            rotate(team) { const s = this.state[team].onCourt; s.push(s.shift()); }
            substitute(team, idx, num) {
                const p = this.state[team].players.find(x => x.num == num);
                if(p) this.state[team].onCourt[idx] = p;
            }
            endSet() {
                (this.state.home.score > this.state.away.score) ? this.state.home.sets++ : this.state.away.sets++;
                this.state.set++; this.state.home.score = 0; this.state.away.score = 0;
                return true;
            }
            generateBackupJSON() { return "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(this.state)); }
            loadFromJSON(json) {
                try { this.state = JSON.parse(json); return true; } catch(e) { return false; }
            }
        }
    </script>

    <div id="setupModal" class="fixed inset-0 bg-black/80 z-[100] flex items-center justify-center backdrop-blur-sm">
        <div class="bg-white dark:bg-gray-800 rounded-2xl p-6 max-w-3xl w-full mx-4 shadow-2xl border border-gray-700">
            
            <div id="stepLoad" class="text-center">
                <h2 class="text-3xl font-bold mb-6 text-primary">VolleyLive Pro</h2>
                <div class="grid grid-cols-1 gap-4">
                    <button onclick="showStep('step1')" class="py-4 bg-primary text-white rounded-xl font-bold hover:bg-blue-600 transition">
                        ‚≠ê Nouveau Match
                    </button>
                    <div onclick="document.getElementById('backupInput').click()" class="py-4 border-2 border-dashed border-gray-300 rounded-xl cursor-pointer hover:bg-gray-50 dark:hover:bg-gray-700 transition">
                        <p class="font-bold">üìÇ Charger une Sauvegarde JSON</p>
                        <input type="file" id="backupInput" accept=".json" class="hidden" onchange="loadGameFromFile(this)">
                    </div>
                </div>
            </div>

            <div id="step1" class="hidden">
                <h3 class="text-xl font-bold mb-4">Configuration</h3>
                <div class="space-y-4">
                    <div><label class="text-xs font-bold text-gray-500">NOM √âQUIPE DOMICILE (NOUS)</label><input type="text" id="homeName" value="Nous" class="w-full rounded-lg border-gray-300 p-2"></div>
                    <div><label class="text-xs font-bold text-gray-500">NOM √âQUIPE EXT√âRIEUR (EUX)</label><input type="text" id="awayName" value="Adversaire" class="w-full rounded-lg border-gray-300 p-2"></div>
                    <div>
                        <label class="text-xs font-bold text-gray-500">PREMIER SERVICE</label>
                        <select id="firstServer" class="w-full rounded-lg border-gray-300 p-2">
                            <option value="home">Nous servons</option>
                            <option value="away">Eux servent</option>
                        </select>
                    </div>
                </div>
                <div class="flex gap-3 mt-6">
                    <button onclick="showStep('stepLoad')" class="px-4 py-2 bg-gray-200 rounded-lg font-bold">Retour</button>
                    <button onclick="initRostersUI(); showStep('step2')" class="flex-1 py-2 bg-primary text-white rounded-lg font-bold">Suivant</button>
                </div>
            </div>

            <div id="step2" class="hidden">
                <h3 class="text-xl font-bold mb-4">Effectifs</h3>
                
                <div class="grid grid-cols-2 gap-6 h-80 overflow-y-auto mb-4 border rounded-lg p-4">
                    <div>
                        <div class="flex justify-between items-center mb-2">
                            <h4 class="font-bold text-primary">Nous (D√©tails)</h4>
                            <button onclick="document.getElementById('excelInput').click()" class="text-xs bg-green-600 text-white px-2 py-1 rounded flex items-center gap-1 hover:bg-green-700">
                                <span class="material-symbols-outlined text-sm">table_view</span> Import Excel
                            </button>
                            <input type="file" id="excelInput" accept=".xlsx, .xls" class="hidden" onchange="importHomeTeamFromExcel(this)">
                        </div>
                        <div id="homeRosterList" class="space-y-2"></div>
                        <button onclick="addPlayerRow('home')" class="text-xs bg-gray-200 px-2 py-1 rounded mt-2 w-full">+ Ajouter Joueur</button>
                    </div>

                    <div>
                        <h4 class="font-bold text-gray-500 mb-2">Eux (Num√©ros)</h4>
                        <div id="awayRosterList" class="space-y-2"></div>
                        <button onclick="addPlayerRow('away')" class="text-xs bg-gray-200 px-2 py-1 rounded mt-2 w-full">+ Ajouter Joueur</button>
                    </div>
                </div>

                <div class="flex gap-3">
                    <button onclick="showStep('step1')" class="px-4 py-3 bg-gray-200 rounded-xl font-bold">Retour</button>
                    <button onclick="startGame()" class="flex-1 py-3 bg-green-600 hover:bg-green-700 text-white rounded-xl font-bold shadow-lg">üöÄ LANCER LE MATCH</button>
                </div>
            </div>
        </div>
    </div>

    <div id="scoreModal" class="hidden fixed inset-0 bg-black/90 z-[100] flex items-center justify-center">
        <div class="bg-white rounded-2xl p-4 max-w-lg w-full mx-4 flex flex-col max-h-[90vh]">
            <h3 id="scoreTitle" class="text-center font-bold text-2xl mb-4 border-b pb-2">Point...</h3>
            <div class="overflow-y-auto flex-1">
                <div id="secWinner" class="mb-4">
                    <h4 class="text-green-600 font-bold text-xs uppercase mb-2">1. Point Gagnant (Action Positive)</h4>
                    <div id="gridWinners" class="grid grid-cols-6 gap-2 mb-2"></div>
                    <div id="actionsWinner" class="hidden grid grid-cols-2 gap-2">
                        <button onclick="finalizeScore('Attaque')" class="p-3 bg-green-50 border-l-4 border-green-500 font-bold rounded">Attaque</button>
                        <button onclick="finalizeScore('Block')" class="p-3 bg-green-50 border-l-4 border-green-500 font-bold rounded">Block</button>
                        <button onclick="finalizeScore('Ace')" class="p-3 bg-green-50 border-l-4 border-green-500 font-bold rounded">Ace</button>
                        <button onclick="finalizeScore('Feinte')" class="p-3 bg-green-50 border-l-4 border-green-500 font-bold rounded">Feinte</button>
                    </div>
                </div>
                <div id="secLoser" class="mb-4">
                    <h4 class="text-red-500 font-bold text-xs uppercase mb-2">2. Faute Adverse</h4>
                    <div id="gridLosers" class="grid grid-cols-6 gap-2 mb-2"></div>
                    <div id="actionsLoser" class="hidden grid grid-cols-2 gap-2">
                        <button onclick="finalizeScore('Attaque Out')" class="p-3 bg-red-50 border-l-4 border-red-500 font-bold rounded">Attaque Out</button>
                        <button onclick="finalizeScore('Faute Filet')" class="p-3 bg-red-50 border-l-4 border-red-500 font-bold rounded">Filet</button>
                        <button onclick="finalizeScore('Faute Service')" class="p-3 bg-red-50 border-l-4 border-red-500 font-bold rounded">Service Rat√©</button>
                        <button onclick="finalizeScore('Faute Main')" class="p-3 bg-red-50 border-l-4 border-red-500 font-bold rounded">Faute Main</button>
                    </div>
                </div>
            </div>
            <button onclick="document.getElementById('scoreModal').classList.add('hidden')" class="py-3 bg-gray-200 font-bold rounded-xl mt-2">Annuler</button>
        </div>
    </div>

    <div id="subModal" class="hidden fixed inset-0 bg-black/80 z-[100] flex items-center justify-center">
        <div class="bg-white p-6 rounded-xl w-80 text-center">
            <h3 class="font-bold text-xl mb-2">Changement</h3>
            <p class="text-sm text-gray-500 mb-4">Sortie : <strong id="subOutName"></strong></p>
            <select id="subInSelect" class="w-full border p-2 rounded mb-4"></select>
            <div class="flex gap-2">
                <button onclick="confirmSub()" class="flex-1 bg-primary text-white py-2 rounded font-bold">Confirmer</button>
                <button onclick="document.getElementById('subModal').classList.add('hidden')" class="flex-1 bg-gray-200 py-2 rounded font-bold">Annuler</button>
            </div>
        </div>
    </div>

    <header class="bg-white dark:bg-bg-dark/50 border-b border-gray-200 px-4 py-3 flex items-center justify-between sticky top-0 z-40 backdrop-blur-md">
        <div class="flex items-center gap-3">
            <div class="p-2 bg-primary/10 rounded-lg text-primary"><span class="material-symbols-outlined block">sports_volleyball</span></div>
            <div>
                <h1 id="matchVersus" class="text-lg font-bold leading-tight">Match</h1>
                <div class="flex items-center gap-2">
                    <span class="text-xs font-bold text-primary px-1.5 py-0.5 bg-primary/10 rounded uppercase">Set <span id="setNum">1</span></span>
                    <span class="text-xs font-medium text-gray-500 uppercase">Sets: <span id="gSetHome">0</span> - <span id="gSetAway">0</span></span>
                </div>
            </div>
        </div>
        <div class="flex items-center gap-2">
            <button onclick="downloadBackup()" class="flex items-center gap-2 px-3 py-1.5 rounded-lg border border-gray-200 text-sm font-semibold hover:bg-gray-50">
                <span class="material-symbols-outlined text-sm">save</span> <span class="hidden sm:inline">Backup</span>
            </button>
            <button onclick="sendToDB()" class="flex items-center gap-2 px-3 py-1.5 rounded-lg bg-primary text-white text-sm font-semibold hover:bg-primary/90 shadow-sm">
                <span class="material-symbols-outlined text-sm">cloud_upload</span> <span class="hidden sm:inline">Sync</span>
            </button>
            <a href="/logout" class="ml-2 flex items-center gap-2 px-3 py-1.5 rounded-lg bg-red-50 text-red-600 text-sm font-semibold hover:bg-red-100 transition-colors">
                <span class="material-symbols-outlined text-sm">logout</span>
            </a>
        </div>
        
    </header>

    <main class="flex-1 flex flex-col max-w-5xl mx-auto w-full p-4 gap-4" id="gameUI" style="display:none;">
        <div class="grid grid-cols-2 gap-4">
            <div class="bg-white rounded-xl p-6 shadow-sm border border-gray-100 flex flex-col items-center justify-center">
                <p id="lblHome" class="text-xs font-bold text-gray-400 uppercase tracking-[0.2em] mb-1">Nous</p>
                <p id="scoreHome" class="text-7xl font-bold tracking-tighter text-primary">0</p>
            </div>
            <div class="bg-white rounded-xl p-6 shadow-sm border border-gray-100 flex flex-col items-center justify-center">
                <p id="lblAway" class="text-xs font-bold text-gray-400 uppercase tracking-[0.2em] mb-1">Eux</p>
                <p id="scoreAway" class="text-7xl font-bold tracking-tighter text-gray-800">0</p>
            </div>
        </div>

        <div class="flex items-center justify-between px-2">
            <h4 class="text-[#616f89] text-xs font-bold uppercase">Terrain</h4>
            <div class="flex items-center gap-2"><span class="size-2 rounded-full bg-red-500 animate-pulse"></span><span class="text-xs font-bold text-gray-500 uppercase">Live</span></div>
        </div>

        <div class="relative w-full aspect-[4/3] max-h-[450px] court-wood rounded-xl border-[6px] border-white shadow-lg overflow-hidden flex flex-col">
            <div class="flex-1 border-b-[3px] border-white/80 relative" id="cAway">
                <div class="absolute bottom-0 w-full h-1 bg-transparent z-0"></div>
                <div onclick="openSub('away', 0)" class="absolute top-[20%] left-[80%] -translate-x-1/2 -translate-y-1/2"><div id="a_p1" class="player-circle bg-white text-gray-800 border-gray-200">?</div></div>
                <div onclick="openSub('away', 5)" class="absolute top-[20%] left-[50%] -translate-x-1/2 -translate-y-1/2"><div id="a_p6" class="player-circle bg-white text-gray-800 border-gray-200">?</div></div>
                <div onclick="openSub('away', 4)" class="absolute top-[20%] left-[20%] -translate-x-1/2 -translate-y-1/2"><div id="a_p5" class="player-circle bg-white text-gray-800 border-gray-200">?</div></div>
                <div onclick="openSub('away', 1)" class="absolute top-[70%] left-[80%] -translate-x-1/2 -translate-y-1/2"><div id="a_p2" class="player-circle bg-white text-gray-800 border-gray-200">?</div></div>
                <div onclick="openSub('away', 2)" class="absolute top-[70%] left-[50%] -translate-x-1/2 -translate-y-1/2"><div id="a_p3" class="player-circle bg-white text-gray-800 border-gray-200">?</div></div>
                <div onclick="openSub('away', 3)" class="absolute top-[70%] left-[20%] -translate-x-1/2 -translate-y-1/2"><div id="a_p4" class="player-circle bg-white text-gray-800 border-gray-200">?</div></div>
            </div>
            <div class="h-4 bg-gray-900/10 backdrop-blur-[1px] net-pattern relative z-10 flex items-center justify-center"><div class="h-0.5 w-full bg-white/50"></div></div>
            <div class="flex-1 relative" id="cHome">
                <div onclick="openSub('home', 3)" class="absolute top-[30%] left-[20%] -translate-x-1/2 -translate-y-1/2"><div id="h_p4" class="player-circle bg-primary text-white border-white">?</div></div>
                <div onclick="openSub('home', 2)" class="absolute top-[30%] left-[50%] -translate-x-1/2 -translate-y-1/2"><div id="h_p3" class="player-circle bg-primary text-white border-white">?</div></div>
                <div onclick="openSub('home', 1)" class="absolute top-[30%] left-[80%] -translate-x-1/2 -translate-y-1/2"><div id="h_p2" class="player-circle bg-primary text-white border-white">?</div></div>
                <div onclick="openSub('home', 4)" class="absolute top-[80%] left-[20%] -translate-x-1/2 -translate-y-1/2"><div id="h_p5" class="player-circle bg-primary text-white border-white">?</div></div>
                <div onclick="openSub('home', 5)" class="absolute top-[80%] left-[50%] -translate-x-1/2 -translate-y-1/2"><div id="h_p6" class="player-circle bg-primary text-white border-white">?</div></div>
                <div onclick="openSub('home', 0)" class="absolute top-[80%] left-[80%] -translate-x-1/2 -translate-y-1/2"><div id="h_p1" class="player-circle bg-primary text-white border-white">?</div></div>
            </div>
        </div>

        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
            <div class="bg-white rounded-xl p-4 shadow-sm border border-gray-100 h-40 overflow-y-auto">
                <p class="text-[10px] font-bold text-gray-400 uppercase tracking-widest mb-3 flex items-center gap-2"><span class="material-symbols-outlined text-sm">list_alt</span> Historique</p>
                <div id="historyLog" class="space-y-2 text-sm"></div>
            </div>
            <div class="bg-white rounded-xl p-4 shadow-sm border border-gray-100 flex flex-col justify-center">
                <button onclick="endSet()" class="w-full py-4 bg-red-50 text-red-600 border border-red-100 rounded-lg text-sm font-bold hover:bg-red-100 transition-colors uppercase tracking-widest">üèÅ Fin du Set (Sauvegarder)</button>
            </div>
        </div>
    </main>

    <div class="bg-white border-t border-gray-200 p-4 sticky bottom-0 z-50">
        <div class="max-w-5xl mx-auto grid grid-cols-2 gap-4">
            <button onclick="openScoreModal('home')" class="flex flex-col items-center justify-center py-4 bg-primary rounded-xl text-white shadow-lg active:scale-95 transition-transform"><span class="material-symbols-outlined text-3xl mb-1">add_circle</span><span class="text-sm font-bold uppercase">+ Point Nous</span></button>
            <button onclick="openScoreModal('away')" class="flex flex-col items-center justify-center py-4 bg-gray-800 rounded-xl text-white shadow-lg active:scale-95 transition-transform"><span class="material-symbols-outlined text-3xl mb-1">add_circle</span><span class="text-sm font-bold uppercase">+ Point Eux</span></button>
        </div>
    </div>

    <script>
        let game = new VolleyMatch();

        function showStep(id) {
            ['stepLoad', 'step1', 'step2'].forEach(s => document.getElementById(s).classList.add('hidden'));
            document.getElementById(id).classList.remove('hidden');
        }

        // --- IMPORT EXCEL ---
        function importHomeTeamFromExcel(input) {
            const file = input.files[0];
            if(!file) return;

            const reader = new FileReader();
            reader.onload = function(e) {
                const data = new Uint8Array(e.target.result);
                const workbook = XLSX.read(data, {type: 'array'});
                const firstSheetName = workbook.SheetNames[0];
                const worksheet = workbook.Sheets[firstSheetName];
                
                // On r√©cup√®re les donn√©es ligne par ligne (Array of Arrays)
                const rows = XLSX.utils.sheet_to_json(worksheet, {header: 1});

                // Vider la liste actuelle
                const container = document.getElementById('homeRosterList');
                container.innerHTML = "";

                // Parcourir les lignes (On saute la ligne 0 si c'est les titres)
                let count = 0;
                rows.forEach((row, index) => {
                    // Structure attendue : COL 0=Nom, 1=Pr√©nom, 2=Num, 3=R√¥le
                    // On v√©rifie s'il y a un num√©ro (Colonne 2) pour savoir si c'est un joueur
                    const num = row[2];
                    
                    if (num && !isNaN(num)) {
                        addPlayerRow('home', count); // Cr√©er les inputs vides
                        
                        // Remplir les inputs
                        const nom = row[0] || "";
                        const prenom = row[1] || "";
                        const role = row[3] || "?";

                        document.getElementById(`home_num_${count}`).value = num;
                        document.getElementById(`home_name_${count}`).value = `${prenom} ${nom}`; // Format : Pr√©nom Nom
                        
                        // Essayer de mapper le r√¥le
                        const roleSelect = document.getElementById(`home_role_${count}`);
                        // Si le texte du r√¥le correspond √† une option, le navigateur le s√©lectionnera
                        // Sinon on essaie de deviner ou on laisse ?
                        roleSelect.value = mapExcelRole(role);
                        
                        count++;
                    }
                });
                alert(`${count} joueurs import√©s !`);
            };
            reader.readAsArrayBuffer(file);
        }

        function mapExcelRole(roleText) {
            // Petite aide pour convertir les r√¥les Excel vers les codes App
            if(!roleText) return "?";
            const r = roleText.toString().toUpperCase();
            if(r.includes("POINT") || r.includes("RECEP") || r === "OH") return "OH";
            if(r.includes("CENTRAL") || r === "MB") return "MB";
            if(r.includes("PASS") || r === "S") return "S";
            if(r.includes("OPPO") || r === "OPP") return "OPP";
            if(r.includes("LIB") || r === "L") return "L";
            return "?";
        }

        function initRostersUI() {
            if(document.getElementById('homeRosterList').innerHTML === "") for(let i=0; i<8; i++) addPlayerRow('home', i);
            if(document.getElementById('awayRosterList').innerHTML === "") for(let i=0; i<8; i++) addPlayerRow('away', i);
        }

        function addPlayerRow(team, idx) {
            const container = document.getElementById(team + 'RosterList');
            const div = document.createElement('div');
            div.className = "flex gap-2 items-center mb-2";
            let html = `<span class="text-xs font-bold w-6 text-gray-400">#${idx+1}</span>
                        <input type="number" id="${team}_num_${idx}" placeholder="N¬∞" class="w-14 p-2 text-sm border rounded bg-gray-50">`;
            if(team === 'home') {
                html += `<input type="text" id="${team}_name_${idx}" placeholder="Nom" class="flex-1 p-2 text-sm border rounded bg-gray-50">
                         <select id="${team}_role_${idx}" class="p-2 text-sm border rounded w-20 bg-gray-50">
                            <option value="?">?</option><option value="OH">R4</option><option value="MB">C</option><option value="S">P</option><option value="OPP">Pt</option><option value="L">L</option>
                         </select>`;
            }
            div.innerHTML = html;
            container.appendChild(div);
        }

        function startGame() {
            const hName = document.getElementById('homeName').value;
            const aName = document.getElementById('awayName').value;
            const server = document.getElementById('firstServer').value;

            const parse = (team) => {
                const list = document.getElementById(team+'RosterList').children;
                let roster = [], starters = [];
                for(let i=0; i<list.length; i++) {
                    let num = document.getElementById(`${team}_num_${i}`).value;
                    let nameEl = document.getElementById(`${team}_name_${i}`);
                    let name = nameEl ? nameEl.value : 'Adv#'+num;
                    let roleEl = document.getElementById(`${team}_role_${i}`);
                    let role = roleEl ? roleEl.value : '?';
                    if(num) {
                        let p = { num, name: name || 'J'+num, role, id: i };
                        roster.push(p);
                        if(i < 6) starters.push(p);
                    }
                }
                while(starters.length < 6) starters.push({num:'?', name:'?', role:'?'});
                return { all: roster, court: starters };
            };

            const h = parse('home'); const a = parse('away');
            game.initializeMatch(hName, aName, server, h.all, h.court, a.all, a.court);
            document.getElementById('setupModal').classList.add('hidden');
            document.getElementById('gameUI').style.display = 'flex';
            updateScreen();
        }

        function updateScreen() {
            const s = game.state;
            document.getElementById('lblHome').innerText = s.home.name;
            document.getElementById('lblAway').innerText = s.away.name;
            document.getElementById('scoreHome').innerText = s.home.score;
            document.getElementById('scoreAway').innerText = s.away.score;
            document.getElementById('setNum').innerText = s.set;
            document.getElementById('gSetHome').innerText = s.home.sets;
            document.getElementById('gSetAway').innerText = s.away.sets;
            document.getElementById('matchVersus').innerText = `${s.home.name} vs ${s.away.name}`;

            const draw = (team, prefix) => {
                s[team].onCourt.forEach((p, i) => {
                    const el = document.getElementById(`${prefix}${i+1}`);
                    if(el) {
                        el.innerHTML = `<span class="text-xl">${p.num}</span><span class="text-[9px] uppercase mt-[-4px]">${p.role || ''}</span>`;
                        if(s.server === team && i === 0) el.classList.add('server-indicator');
                        else el.classList.remove('server-indicator');
                    }
                });
            };
            draw('home', 'h_p'); draw('away', 'a_p');

            const logDiv = document.getElementById('historyLog');
            logDiv.innerHTML = s.history.slice(-3).reverse().map(h => `
                <div class="flex justify-between items-center border-b pb-1">
                    <span class="font-bold ${h.winner_team === s.home.name ? 'text-primary' : 'text-gray-600'}">${h.winner_team} (+1)</span>
                    <span class="text-xs bg-gray-100 px-2 rounded">${h.action} (${h.actor_num})</span>
                </div>
            `).join('');
        }

        function openScoreModal(winner) {
            game.state.tempPoint = { winner, actorTeam: null, actorNum: null };
            document.getElementById('scoreTitle').innerText = `Point pour ${game.state[winner].name}`;
            document.getElementById('actionsWinner').classList.add('hidden');
            document.getElementById('actionsLoser').classList.add('hidden');
            const loser = winner === 'home' ? 'away' : 'home';
            fillGrid('gridWinners', winner, true);
            fillGrid('gridLosers', loser, false);
            document.getElementById('scoreModal').classList.remove('hidden');
        }

        function fillGrid(elemId, team, isPos) {
            const div = document.getElementById(elemId); div.innerHTML = '';
            game.state[team].onCourt.forEach(p => {
                let btn = document.createElement('button');
                btn.className = "h-10 w-10 rounded-full border border-gray-300 font-bold hover:bg-primary hover:text-white transition shadow-sm";
                btn.innerText = p.num;
                btn.onclick = () => {
                    Array.from(div.children).forEach(c => c.classList.remove('bg-primary', 'text-white'));
                    btn.classList.add('bg-primary', 'text-white');
                    game.state.tempPoint.actorTeam = team; game.state.tempPoint.actorNum = p.num;
                    document.getElementById(isPos ? 'actionsWinner' : 'actionsLoser').classList.remove('hidden');
                    document.getElementById(isPos ? 'actionsLoser' : 'actionsWinner').classList.add('hidden');
                };
                div.appendChild(btn);
            });
        }

        function finalizeScore(action) {
            game.scorePoint(game.state.tempPoint.winner, { action: action, actorTeam: game.state.tempPoint.actorTeam, actorNum: game.state.tempPoint.actorNum });
            document.getElementById('scoreModal').classList.add('hidden');
            updateScreen();
        }

        function openSub(team, idx) {
            game.state.subTarget = { team, idx };
            const sel = document.getElementById('subInSelect'); sel.innerHTML = '';
            const currentIds = game.state[team].onCourt.map(p => p.num);
            game.state[team].players.forEach(p => {
                if(!currentIds.includes(p.num)) {
                    let opt = document.createElement('option'); opt.value = p.num; opt.innerText = `#${p.num} ${p.name}`; sel.appendChild(opt);
                }
            });
            document.getElementById('subOutName').innerText = game.state[team].onCourt[idx].name;
            document.getElementById('subModal').classList.remove('hidden');
        }

        function confirmSub() {
            game.substitute(game.state.subTarget.team, game.state.subTarget.idx, document.getElementById('subInSelect').value);
            document.getElementById('subModal').classList.add('hidden');
            updateScreen();
        }

        function endSet() { if(game.endSet()) { downloadBackup(); updateScreen(); } }
        function downloadBackup() {
            const a = document.createElement('a'); a.href = game.generateBackupJSON(); a.download = `VOLLEY_BACKUP_${Date.now()}.json`; document.body.appendChild(a); a.click(); a.remove();
        }
        function loadGameFromFile(input) {
            const file = input.files[0]; if(!file) return;
            const r = new FileReader();
            r.onload = (e) => {
                if(game.loadFromJSON(e.target.result)) {
                    document.getElementById('setupModal').classList.add('hidden');
                    document.getElementById('gameUI').style.display = 'flex';
                    updateScreen();
                    alert("Partie charg√©e !");
                } else alert("Fichier invalide");
            };
            r.readAsText(file);
        }
        async function sendToDB() {
            if(!confirm("Synchroniser vers le Cloud ?")) return;
            try {
                const res = await fetch('/api/save_match', { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify(game.state) });
                const json = await res.json(); alert(json.message);
            } catch(e) { alert("Erreur Cloud : " + e); }
        }
    </script>
</body>
</html>

