<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>VolleyLive Pro - Match Complet</title>
    <style>
        :root { --primary: #2c3e50; --accent: #e74c3c; --success: #27ae60; }
        body { font-family: 'Segoe UI', sans-serif; margin: 0; padding: 10px; background: #f4f4f4; user-select: none; }
        .hidden { display: none !important; }
        
        /* LAYOUT */
        .container { max-width: 1000px; margin: 0 auto; background: white; padding: 15px; border-radius: 8px; display: none; }
        .btn { padding: 12px; border: none; border-radius: 6px; cursor: pointer; font-weight: bold; font-size: 1rem; width: 100%; color:white; margin-bottom: 5px; }
        .btn-green { background: var(--success); }
        .btn-blue { background: var(--primary); }
        .btn-red { background: var(--accent); }
        .btn-gray { background: #7f8c8d; }

        /* HEADER AVEC SETS GLOBAUX */
        .top-bar { display: flex; justify-content: space-between; align-items: center; border-bottom: 2px solid #eee; padding-bottom: 10px; margin-bottom: 10px;}
        .global-sets { font-size: 1.5rem; font-weight: bold; color: var(--primary); background: #eee; padding: 5px 15px; border-radius: 20px; }

        /* SCOREBOARD DU SET ACTUEL */
        .scoreboard { display: flex; justify-content: center; align-items: center; gap: 40px; margin: 10px 0; font-size: 3.5rem; font-weight: 800; color: #333; }
        .score-box { text-align: center; }
        .score-label { font-size: 1rem; color: #666; display: block; font-weight: normal; }

        /* TERRAIN */
        .court-container { display: flex; justify-content: space-between; gap: 10px; margin-bottom: 10px; }
        .court-side { border: 3px solid #333; width: 49%; height: 320px; position: relative; background: #fff; border-radius: 4px; }
        .net { position: absolute; top: 0; bottom: 0; width: 6px; background: black; z-index: 10; }
        .left-net { left: 100%; } .right-net { left: 0; }
        
        .player-pos { 
            width: 45px; height: 45px; background: white; border: 2px solid #ccc; 
            position: absolute; display: flex; flex-direction: column; align-items: center; justify-content: center; 
            font-size: 0.9em; border-radius: 50%; box-shadow: 2px 2px 5px rgba(0,0,0,0.2); 
            cursor: pointer; 
        }
        .player-pos.server { border-color: var(--accent); border-width: 3px; background: #fff5f5; }
        
        /* POSITIONS */
        .p4 { top: 20%; left: 20%; } .p3 { top: 20%; left: 50%; } .p2 { top: 20%; left: 80%; }
        .p5 { top: 70%; left: 20%; } .p6 { top: 70%; left: 50%; } .p1 { top: 70%; left: 80%; }
        .right-side .p2 { left: 20%; } .right-side .p3 { left: 50%; } .right-side .p4 { left: 80%; }
        .right-side .p1 { left: 20%; } .right-side .p6 { left: 50%; } .right-side .p5 { left: 80%; }

        /* MODALES */
        .modal-overlay { position: fixed; top:0; left:0; width:100%; height:100%; background: rgba(44, 62, 80, 0.95); z-index:100; display: flex; align-items: center; justify-content: center; }
        .modal-box { background: white; width: 95%; max-width: 600px; padding: 20px; border-radius: 12px; overflow-y: auto; max-height: 90vh; }
        
        /* SCORING STYLES */
        .player-grid { display: grid; grid-template-columns: repeat(6, 1fr); gap: 5px; margin: 10px 0; }
        .player-btn { background: #ecf0f1; border: 1px solid #bdc3c7; padding: 10px 2px; border-radius: 4px; font-weight: bold; cursor: pointer; text-align: center;}
        .player-btn.selected { background: var(--primary); color: white; }
        .action-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
        .action-btn { padding: 10px; border: 1px solid #ddd; border-radius: 6px; cursor: pointer; background: white; }
        .act-good { border-left: 5px solid var(--success); } .act-bad { border-left: 5px solid var(--accent); }
    </style>
</head>
<body>

<div id="setupModal" class="modal-overlay">
    <div class="modal-box">
        <div id="step1">
            <h2>Nouveau Match</h2>
            <p><label>Nous (Domicile)</label><input type="text" id="homeName" value="Mon Club" style="width:100%; padding:5px;"></p>
            <p><label>Eux (Ext√©rieur)</label><input type="text" id="awayName" value="Adversaire" style="width:100%; padding:5px;"></p>
            <p><label>Premier Service</label><select id="firstServer" style="width:100%; padding:5px;"><option value="home">Nous</option><option value="away">Eux</option></select></p>
            <button class="btn btn-green" onclick="toStep2()">Suivant</button>
        </div>
        <div id="step2" class="hidden">
            <h3>Effectifs</h3>
            <div style="display:flex; gap:10px;">
                <div style="flex:1"><h4>Nous</h4><div id="homeRosterList"></div><button class="btn btn-gray" onclick="addPlayerRow('home')">+ J</button></div>
                <div style="flex:1"><h4>Eux</h4><div id="awayRosterList"></div><button class="btn btn-gray" onclick="addPlayerRow('away')">+ J</button></div>
            </div>
            <br>
            <button class="btn btn-green" onclick="startGame()">Lancer Match</button>
        </div>
    </div>
</div>

<div id="scoreModal" class="modal-overlay hidden">
    <div class="modal-box">
        <h3 id="scoreTitle" style="text-align:center; margin:0;">Point...</h3>
        
        <div id="secWinner">
            <h4 style="color: var(--success); margin:5px 0;">1. Point Gagnant (Notre Action)</h4>
            <div class="player-grid" id="gridWinners"></div>
            <div id="actionsWinner" class="action-grid hidden">
                <button class="action-btn act-good" onclick="finalizeScore('Attaque')">Attaque</button>
                <button class="action-btn act-good" onclick="finalizeScore('Block')">Block</button>
                <button class="action-btn act-good" onclick="finalizeScore('Ace')">Ace</button>
                <button class="action-btn act-good" onclick="finalizeScore('Feinte')">Feinte</button>
            </div>
        </div>
        <hr>
        <div id="secLoser">
            <h4 style="color: var(--accent); margin:5px 0;">2. Faute Adverse (Leur Erreur)</h4>
            <div class="player-grid" id="gridLosers"></div>
            <div id="actionsLoser" class="action-grid hidden">
                <button class="action-btn act-bad" onclick="finalizeScore('Attaque Out')">Attaque Out</button>
                <button class="action-btn act-bad" onclick="finalizeScore('Faute Filet')">Filet</button>
                <button class="action-btn act-bad" onclick="finalizeScore('Faute Service')">Service Rat√©</button>
                <button class="action-btn act-bad" onclick="finalizeScore('Faute Main')">Faute Main</button>
            </div>
        </div>
        <button class="btn btn-gray" onclick="closeScoreModal()" style="margin-top:10px;">Annuler</button>
    </div>
</div>

<div id="subModal" class="modal-overlay hidden">
    <div class="modal-box">
        <h3>Changement</h3>
        <p>Sortie : <strong id="subOutName">...</strong></p>
        <select id="subInSelect" style="width:100%; padding:10px; margin-bottom:10px;"></select>
        <button class="btn btn-green" onclick="confirmSub()">Confirmer</button>
        <button class="btn btn-gray" onclick="closeSubModal()">Annuler</button>
    </div>
</div>

<div class="container" id="gameUI">
    <div class="top-bar">
        <div>
            <strong>Set <span id="setNum">1</span></strong>
            <div id="matchVersus" style="font-size:0.8em; color:#666;"></div>
        </div>
        <div class="global-sets">
            Sets : <span id="gSetHome">0</span> - <span id="gSetAway">0</span>
        </div>
        <div style="display:flex; gap:5px;">
            <button class="btn btn-gray" onclick="downloadCSV()" style="font-size:0.8rem; width:auto;">üì• CSV</button>
            <button class="btn btn-blue" onclick="sendToDB()" style="font-size:0.8rem; width:auto;">‚òÅÔ∏è Cloud</button>
        </div>
    </div>

    <div class="scoreboard">
        <div class="score-box"><span class="score-label" id="lblHome">Nous</span><span id="scoreHome">0</span></div>
        <div>-</div>
        <div class="score-box"><span class="score-label" id="lblAway">Eux</span><span id="scoreAway">0</span></div>
    </div>

    <div class="court-container">
        <div class="court-side" id="cHome">
            <div class="net left-net"></div>
            <div class="player-pos p4" id="h_p4" onclick="openSub('home', 3)"></div>
            <div class="player-pos p3" id="h_p3" onclick="openSub('home', 2)"></div>
            <div class="player-pos p2" id="h_p2" onclick="openSub('home', 1)"></div>
            <div class="player-pos p5" id="h_p5" onclick="openSub('home', 4)"></div>
            <div class="player-pos p6" id="h_p6" onclick="openSub('home', 5)"></div>
            <div class="player-pos p1" id="h_p1" onclick="openSub('home', 0)"></div>
        </div>
        <div class="court-side right-side" id="cAway">
            <div class="net right-net"></div>
            <div class="player-pos p4" id="a_p4" onclick="openSub('away', 3)"></div>
            <div class="player-pos p3" id="a_p3" onclick="openSub('away', 2)"></div>
            <div class="player-pos p2" id="a_p2" onclick="openSub('away', 1)"></div>
            <div class="player-pos p5" id="a_p1" onclick="openSub('away', 4)"></div>
            <div class="player-pos p6" id="a_p6" onclick="openSub('away', 5)"></div>
            <div class="player-pos p1" id="a_p5" onclick="openSub('away', 0)"></div>
        </div>
    </div>

    <div style="display:grid; grid-template-columns:1fr 1fr; gap:20px;">
        <button class="btn btn-blue" onclick="openScoreModal('home')">+ POINT NOUS</button>
        <button class="btn btn-blue" onclick="openScoreModal('away')">+ POINT EUX</button>
    </div>

    <hr style="margin:20px 0;">

    <button class="btn btn-red" onclick="endSet()" style="padding:15px;">üèÅ FIN DU SET (Passer au suivant)</button>

</div>

<script>
    // --- ETAT GLOBAL ---
    const state = {
        home: { name: "", score: 0, sets: 0, players: [], onCourt: [] },
        away: { name: "", score: 0, sets: 0, players: [], onCourt: [] },
        server: null,
        set: 1,
        history: [], // Stocke TOUS les points de TOUS les sets
        tempPoint: {}
    };

    // --- SETUP ---
    function toStep2() {
        document.getElementById('step1').classList.add('hidden');
        document.getElementById('step2').classList.remove('hidden');
        if(document.getElementById('homeRosterList').innerHTML==="") for(let i=0;i<8;i++) addPlayerRow('home', i);
        if(document.getElementById('awayRosterList').innerHTML==="") for(let i=0;i<8;i++) addPlayerRow('away', i);
    }
    
    function addPlayerRow(team, idx) {
        // ... (M√™me logique que pr√©c√©demment pour ajouter les inputs)
        const container = document.getElementById(team + 'RosterList');
        const count = container.children.length;
        const div = document.createElement('div');
        div.style.marginBottom = "5px";
        const lbl = count < 6 ? `<b>Z${count+1}</b>` : `<span style="color:#999">R</span>`;
        div.innerHTML = `
            ${lbl} <input type="number" id="${team}_num_${count}" placeholder="#" style="width:40px">
            <input type="text" id="${team}_name_${count}" placeholder="Nom" style="width:80px">
        `;
        container.appendChild(div);
    }

    function startGame() {
        state.home.name = document.getElementById('homeName').value;
        state.away.name = document.getElementById('awayName').value;
        state.server = document.getElementById('firstServer').value;

        // Parsing
        const parse = (team) => {
            const list = document.getElementById(team+'RosterList').children;
            let roster=[], starters=[];
            for(let i=0; i<list.length; i++) {
                let num = document.getElementById(`${team}_num_${i}`).value;
                let name = document.getElementById(`${team}_name_${i}`).value;
                if(num) {
                    let p = {num, name: name||'J'+num, id:i};
                    roster.push(p);
                    if(i<6) starters.push(p);
                }
            }
            while(starters.length<6) starters.push({num:'?', name:'?'});
            return {all:roster, court:starters};
        };

        const h = parse('home'); state.home.players = h.all; state.home.onCourt = h.court;
        const a = parse('away'); state.away.players = a.all; state.away.onCourt = a.court;

        // UI Init
        document.getElementById('lblHome').innerText = state.home.name;
        document.getElementById('lblAway').innerText = state.away.name;
        document.getElementById('matchVersus').innerText = `${state.home.name} vs ${state.away.name}`;
        document.getElementById('setupModal').classList.add('hidden');
        document.getElementById('gameUI').style.display = 'block';
        renderCourt();
    }

    // --- FIN DE SET ---
    function endSet() {
        if(!confirm("Confirmer la fin du set ? Le score du set sera remis √† 0.")) return;

        // 1. Mise √† jour du score global des sets
        if(state.home.score > state.away.score) state.home.sets++;
        else state.away.sets++;

        // 2. Reset pour le set suivant
        state.set++;
        state.home.score = 0;
        state.away.score = 0;

        // 3. UI Updates
        document.getElementById('setNum').innerText = state.set;
        document.getElementById('gSetHome').innerText = state.home.sets;
        document.getElementById('gSetAway').innerText = state.away.sets;
        
        // Note: On garde les rotations actuelles (state.onCourt ne change pas)
        // Mais il faut souvent demander qui sert. Par d√©faut on laisse l'√©tat actuel
        // Le coach pourra faire un changement manuel si besoin.
        
        alert(`Set termin√© ! Score Sets : ${state.home.name} ${state.home.sets} - ${state.away.sets} ${state.away.name}. Pr√™t pour le Set ${state.set}.`);
        renderCourt();
    }

    // --- SCORING & LOGIQUE ---
    function openScoreModal(winner) {
        state.tempPoint = { winner, actorTeam: null, actorNum: null };
        const loser = winner==='home'?'away':'home';
        document.getElementById('scoreTitle').innerText = `Point ${state[winner].name}`;
        
        document.getElementById('actionsWinner').classList.add('hidden');
        document.getElementById('actionsLoser').classList.add('hidden');

        genGrid('gridWinners', winner, true);
        genGrid('gridLosers', loser, false);
        document.getElementById('scoreModal').classList.remove('hidden');
    }

    function genGrid(id, team, isPos) {
        const div = document.getElementById(id); div.innerHTML='';
        state[team].onCourt.forEach(p => {
            let b = document.createElement('div');
            b.className = 'player-btn'; b.innerText = p.num;
            b.onclick = () => {
                document.querySelectorAll('.player-btn').forEach(x=>x.classList.remove('selected'));
                b.classList.add('selected');
                state.tempPoint.actorTeam = team; state.tempPoint.actorNum = p.num;
                document.getElementById(isPos?'actionsWinner':'actionsLoser').classList.remove('hidden');
                document.getElementById(isPos?'actionsLoser':'actionsWinner').classList.add('hidden');
            };
            div.appendChild(b);
        });
    }

    function finalizeScore(action) {
        const { winner, actorTeam, actorNum } = state.tempPoint;
        
        // Save Context
        const servT = state.server;
        const servNum = state[servT].onCourt[0].num;
        const rotH = state.home.onCourt.map(p=>p.num).join('-');
        const rotA = state.away.onCourt.map(p=>p.num).join('-');

        state[winner].score++;
        
        state.history.push({
            set: state.set,
            score_dom: state.home.score, score_ext: state.away.score,
            winner_team: state[winner].name,
            point_type: (actorTeam===winner)?'Gagnant':'Faute',
            action: action,
            actor_num: actorNum, actor_team: state[actorTeam].name,
            server_team: state[servT].name, server_num: servNum,
            rot_home: rotH, rot_away: rotA
        });

        if(state.server !== winner) {
            let mover = state[winner].onCourt.shift();
            state[winner].onCourt.push(mover);
            state.server = winner;
        }

        document.getElementById('scoreModal').classList.add('hidden');
        renderCourt();
    }
    
    function closeScoreModal() { document.getElementById('scoreModal').classList.add('hidden'); }

    // --- SUB & RENDER ---
    function openSub(team, idx) {
        state.subTarget = {team, idx};
        const sel = document.getElementById('subInSelect'); sel.innerHTML='';
        const current = state[team].onCourt.map(p=>p.num);
        state[team].players.forEach(p => {
            if(!current.includes(p.num)) {
                let o = document.createElement('option'); o.value=p.num; o.innerText=`#${p.num} ${p.name}`;
                sel.appendChild(o);
            }
        });
        document.getElementById('subOutName').innerText = state[team].onCourt[idx].name;
        document.getElementById('subModal').classList.remove('hidden');
    }
    function confirmSub() {
        const {team, idx} = state.subTarget;
        const val = document.getElementById('subInSelect').value;
        state[team].onCourt[idx] = state[team].players.find(p=>p.num==val);
        document.getElementById('subModal').classList.add('hidden');
        renderCourt();
    }
    function closeSubModal() { document.getElementById('subModal').classList.add('hidden'); }

    function renderCourt() {
        document.getElementById('scoreHome').innerText = state.home.score;
        document.getElementById('scoreAway').innerText = state.away.score;
        
        const draw = (t, pf) => {
            state[t].onCourt.forEach((p, i) => {
                const el = document.getElementById(`${pf}${i+1}`);
                el.innerHTML = `<span>${p.num}</span>`;
                if(state.server===t && i===0) el.classList.add('server');
                else el.classList.remove('server');
            });
        };
        draw('home', 'h_p'); draw('away', 'a_p');
    }

    // --- EXPORT & DB ---
    function downloadCSV() {
        let csv = "Set;ScoreDom;ScoreExt;Vainqueur;Action;Joueur;Equipe;Serveur\n";
        state.history.forEach(r => {
            csv += `${r.set};${r.score_dom};${r.score_ext};${r.winner_team};${r.action};${r.actor_num};${r.actor_team};${r.server_num}\n`;
        });
        const blob = new Blob(["\ufeff"+csv], {type:'text/csv;charset=utf-8;'});
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a'); a.href=url; a.download=`Stats_Match.csv`; a.click();
    }

    async function sendToDB() {
        if(!confirm("Envoyer tout l'historique du match vers la base de donn√©es ?")) return;
        
        const payload = {
            homeName: state.home.name,
            awayName: state.away.name,
            setsHome: state.home.sets,
            setsAway: state.away.sets,
            winner: state.home.sets > state.away.sets ? state.home.name : (state.away.sets > state.home.sets ? state.away.name : "En cours"),
            history: state.history
        };

        try {
            const res = await fetch('/api/save_match', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify(payload)
            });
            const json = await res.json();
            alert(json.message);
        } catch(e) {
            alert("Erreur de connexion au serveur : " + e);
        }
    }
</script>
</body>
</html>
